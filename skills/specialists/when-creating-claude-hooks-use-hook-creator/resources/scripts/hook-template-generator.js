#!/usr/bin/env node
/**
 * Hook Template Generator
 *
 * Generates hook scripts from templates with customized configuration.
 *
 * Usage:
 *   node hook-template-generator.js --type pre --name my-validator --event PreToolUse
 *   node hook-template-generator.js --type post --name audit-logger --event PostToolUse --log-file ./audit.jsonl
 *
 * Options:
 *   --type       Hook type: pre (blocking) or post (observational)
 *   --name       Hook name (used for logging and file naming)
 *   --event      Event type: PreToolUse, PostToolUse, UserPromptSubmit, etc.
 *   --output     Output directory (default: current directory)
 *   --log-file   For post hooks: path to audit log file
 *   --fail-open  For pre hooks: fail open on errors (default: true)
 *   --help       Show this help message
 *
 * @module hooks/scripts/hook-template-generator
 * @version 1.0.0
 */

const fs = require('fs');
const path = require('path');

// Parse command line arguments
function parseArgs(args) {
  const options = {
    type: 'pre',
    name: 'my-hook',
    event: 'PreToolUse',
    output: process.cwd(),
    logFile: null,
    failOpen: true,
    help: false
  };

  for (let i = 0; i < args.length; i++) {
    const arg = args[i];
    const next = args[i + 1];

    switch (arg) {
      case '--type':
        options.type = next;
        i++;
        break;
      case '--name':
        options.name = next;
        i++;
        break;
      case '--event':
        options.event = next;
        i++;
        break;
      case '--output':
        options.output = next;
        i++;
        break;
      case '--log-file':
        options.logFile = next;
        i++;
        break;
      case '--fail-open':
        options.failOpen = next !== 'false';
        i++;
        break;
      case '--help':
      case '-h':
        options.help = true;
        break;
    }
  }

  return options;
}

// Show help message
function showHelp() {
  console.log(`
Hook Template Generator

Usage:
  node hook-template-generator.js [options]

Options:
  --type       Hook type: pre (blocking) or post (observational)
  --name       Hook name (used for logging and file naming)
  --event      Event type: PreToolUse, PostToolUse, UserPromptSubmit, etc.
  --output     Output directory (default: current directory)
  --log-file   For post hooks: path to audit log file
  --fail-open  For pre hooks: fail open on errors (default: true)
  --help       Show this help message

Examples:
  node hook-template-generator.js --type pre --name command-validator --event PreToolUse
  node hook-template-generator.js --type post --name audit-logger --event PostToolUse --log-file ./audit.jsonl

Event Types:
  Blocking:      UserPromptSubmit, SessionStart, PreToolUse, PermissionRequest
  Observational: PostToolUse, Notification, Stop, SubagentStop, PreCompact, SessionEnd
`);
}

// Generate pre-hook template
function generatePreHook(options) {
  return `#!/usr/bin/env node
/**
 * ${options.name}
 *
 * Pre-hook for ${options.event} event.
 * Generated by hook-template-generator.
 *
 * @module hooks/${options.name}
 * @version 1.0.0
 */

const fs = require('fs');

// Configuration
const HOOK_NAME = '${options.name}';
const FAIL_OPEN = ${options.failOpen};
const LOG_PERFORMANCE = true;

/**
 * Main hook processing function
 * @param {Object} input - Hook input from Claude Code
 * @returns {Object} Hook output
 */
function processHook(input) {
  // ===========================================
  // IMPLEMENT YOUR VALIDATION LOGIC HERE
  // ===========================================

  // Example: Add your validation rules
  // if (shouldBlock(input)) {
  //   return {
  //     continue: false,
  //     decision: 'block',
  //     reason: 'Your reason here'
  //   };
  // }

  // Default: Approve
  return {
    continue: true,
    decision: 'approve'
  };
}

/**
 * Main execution
 */
function main() {
  const startTime = process.hrtime.bigint();

  try {
    const input = JSON.parse(fs.readFileSync(0, 'utf-8'));

    if (!input || !input.session_id) {
      console.error(\`[\${HOOK_NAME}] Invalid input\`);
      console.log(JSON.stringify({ continue: FAIL_OPEN }));
      process.exit(1);
    }

    const result = processHook(input);
    console.log(JSON.stringify(result));

    if (LOG_PERFORMANCE) {
      const durationMs = Number(process.hrtime.bigint() - startTime) / 1_000_000;
      console.error(\`[PERF] \${HOOK_NAME} completed in \${durationMs.toFixed(2)}ms\`);
    }

  } catch (error) {
    console.error(\`[\${HOOK_NAME}] Error: \${error.message}\`);
    console.log(JSON.stringify({ continue: FAIL_OPEN }));
    process.exit(1);
  }
}

main();
`;
}

// Generate post-hook template
function generatePostHook(options) {
  const logFileCode = options.logFile
    ? `const LOG_FILE = '${options.logFile}';`
    : `const LOG_FILE = null;  // Set to file path for audit logging`;

  return `#!/usr/bin/env node
/**
 * ${options.name}
 *
 * Post-hook for ${options.event} event.
 * Generated by hook-template-generator.
 *
 * @module hooks/${options.name}
 * @version 1.0.0
 */

const fs = require('fs');

// Configuration
const HOOK_NAME = '${options.name}';
${logFileCode}
const LOG_PERFORMANCE = true;

/**
 * Main hook processing function
 * @param {Object} input - Hook input from Claude Code
 * @returns {Object} Hook output
 */
function processHook(input) {
  // ===========================================
  // IMPLEMENT YOUR PROCESSING LOGIC HERE
  // ===========================================

  // Example: Audit logging
  if (LOG_FILE) {
    const entry = {
      timestamp: new Date().toISOString(),
      session_id: input.session_id,
      tool_name: input.tool_name,
      success: input.tool_response?.exit_code === 0 || input.tool_response?.success
    };

    try {
      fs.appendFileSync(LOG_FILE, JSON.stringify(entry) + '\\n');
    } catch (e) {
      console.error(\`[\${HOOK_NAME}] Log error: \${e.message}\`);
    }
  }

  return { suppressOutput: false };
}

/**
 * Main execution
 */
function main() {
  const startTime = process.hrtime.bigint();

  try {
    const input = JSON.parse(fs.readFileSync(0, 'utf-8'));

    if (!input || !input.session_id) {
      console.error(\`[\${HOOK_NAME}] Invalid input\`);
      console.log(JSON.stringify({ suppressOutput: false }));
      process.exit(1);
    }

    const result = processHook(input);
    console.log(JSON.stringify(result));

    if (LOG_PERFORMANCE) {
      const durationMs = Number(process.hrtime.bigint() - startTime) / 1_000_000;
      console.error(\`[PERF] \${HOOK_NAME} completed in \${durationMs.toFixed(2)}ms\`);
    }

  } catch (error) {
    console.error(\`[\${HOOK_NAME}] Error: \${error.message}\`);
    console.log(JSON.stringify({ suppressOutput: false }));
    process.exit(1);
  }
}

main();
`;
}

// Generate settings.json snippet
function generateSettingsSnippet(options) {
  const eventType = options.event;
  const hookPath = path.join(options.output, `${options.name}.js`);

  return {
    [eventType]: [
      {
        type: 'command',
        command: `node ${hookPath}`,
        timeout: options.type === 'pre' ? 5000 : 10000
      }
    ]
  };
}

// Main function
function main() {
  const args = process.argv.slice(2);
  const options = parseArgs(args);

  if (options.help) {
    showHelp();
    process.exit(0);
  }

  // Validate options
  if (!['pre', 'post'].includes(options.type)) {
    console.error(`Invalid type: ${options.type}. Use 'pre' or 'post'.`);
    process.exit(1);
  }

  const validEvents = [
    'UserPromptSubmit', 'SessionStart', 'PreToolUse', 'PermissionRequest',
    'PostToolUse', 'Notification', 'Stop', 'SubagentStop', 'PreCompact', 'SessionEnd'
  ];

  if (!validEvents.includes(options.event)) {
    console.error(`Invalid event: ${options.event}`);
    console.error(`Valid events: ${validEvents.join(', ')}`);
    process.exit(1);
  }

  // Generate hook code
  const hookCode = options.type === 'pre'
    ? generatePreHook(options)
    : generatePostHook(options);

  // Write hook file
  const outputPath = path.join(options.output, `${options.name}.js`);
  fs.writeFileSync(outputPath, hookCode);
  console.log(`Generated: ${outputPath}`);

  // Generate settings snippet
  const settingsSnippet = generateSettingsSnippet(options);
  console.log('\nAdd to .claude/settings.json "hooks" section:');
  console.log(JSON.stringify(settingsSnippet, null, 2));

  console.log('\nNext steps:');
  console.log(`1. Implement your logic in ${outputPath}`);
  console.log('2. Add the settings snippet to .claude/settings.json');
  console.log(`3. Test with: echo '{"session_id":"test"}' | node ${outputPath}`);
}

main();
